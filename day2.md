# openvswitchを使う

rpmをインストールしたのでopenvswitchが使えるようになりました．
使う際にはbridgeとして設定します．ここでは元々存在するeth0と
ovsbr0と名前をつけたbridge用のnetwork-scriptsを設定します．
macアドレスをスクリプト内に記載する必要はありません．

    $ cd /etc/sysconfig/network-scripts
    
    $ cat ifcfg-eth0
    DEVICE=eth0
    DEVICETYPE=ovs
    HOTPLUG=no
    NM_CONTROLLED=no
    ONBOOT=yes
    OVS_BRIDGE=ovsbr0
    TYPE=OVSPort
    
    $ cat ifcfg-ovsbr0
    DEVICE=ovsbr0
    DEVICETYPE=ovs
    HOTPLUG=no
    NM_CONTROLLED=no
    ONBOOT=yes
    OVSBOOTPROTO=dhcp
    OVSDHCPINTERFACES=eth0
    TYPE=OVSBridge

この設定をみるとわかるように，openvswitch特有の変数が存在します．
ここに記述している変数はrhel用でopenvswitch-1.7.3/rhel/README.RHEL
に説明があり，それをまとめると以下のようになります．

* DEVICETYPT: ovs
* TYPE:
    * OVSBridge: <name>という名前のOVSbridge．これ以外の場合はPortを意味する
    * OVSPort: <name>はeth0のような物理ポートかvif1.0のような仮想ポート
    *  OVSIntPort: <name>はtagged VLANのようなinternal port
    *  OVSBond: <name>はOVS bond
* OVS_BRIDGE: TYPEがOVSBridgeでない場合にポートが所属しているOVS bridge名
* OVS_OPTIONS: Port用のオプション．tag=100だとVLAN100を意味する．ovs-vsctl(8)のadd-portの項とovs-vswitchd.conf.db(5)参照
* OVS_EXTRA: -- で区切られた追加のovs-vsctlコマンド
* BOND_IFACES: OVSBondインタフェース用のbond対象の物理インタフェースリスト

openvswitch設定前のネットワークアドレスは以下のようになっている
はずですが，

    $ ip addr
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        inet6 ::1/128 scope host
           valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
        link/ether 00:0c:29:9c:8c:31 brd ff:ff:ff:ff:ff:ff
        inet 172.16.3.140/24 brd 172.16.3.255 scope global eth0
        inet6 fe80::20c:29ff:fe9c:8c31/64 scope link
           valid_lft forever preferred_lft forever

networkをrestartすると

    $ sudo /etc/init.d/network restart
    インターフェース eth0 を終了中:                            [  OK  ]
    ループバックインターフェースを終了中                       [  OK  ]
    ループバックインターフェイスを呼び込み中                   [  OK  ]
    インターフェース eth0 を活性化中: 
    ovsbr0 のIP情報を検出中... 完了。
                                                               [  OK  ]
    インターフェース ovsbr0 を活性化中:                        [  OK  ]

以下のようにeth0からIPアドレスがなくなり，ovsbr0にIPアドレスが
着くようになります．

    $ ip addr
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        inet6 ::1/128 scope host
           valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
        link/ether 00:0c:29:9c:8c:31 brd ff:ff:ff:ff:ff:ff
        inet6 fe80::20c:29ff:fe9c:8c31/64 scope link
           valid_lft forever preferred_lft forever
    3: ovsbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN
        link/ether 00:0c:29:9c:8c:31 brd ff:ff:ff:ff:ff:ff
        inet 172.16.3.140/24 brd 172.16.3.255 scope global ovsbr0
        inet6 fe80::20c:29ff:fe9c:8c31/64 scope link
           valid_lft forever preferred_lft forever

この時mac上でFusionから以下のようなメッセージがでますので，
管理者権限のパスワードで承認を行ってください．

> 仮想マシンがすべてのネットワークトラフィックを監視しようと
していますが，これには管理者アクセスが必要です．これを許可
するにはパスワードを入力してください

ipコマンドを実行したとき，eth1がなかったり，別の名前になっている
ことがあるかもしれませんそれはudevがよけいなおせっかいを行っている
ためです．70-persisten-net.rulesに想定外の記述がないか確認して
ください．今回のケースでは以下のようになっているべきです．

    $ sudo cat /etc/udev/rules.d/70-persistent-net.rules
    # This file was automatically generated by the /lib/udev/write_net_rules
    # program, run by the persistent-net-generator.rules rules file.
    #
    # You can modify it, as long as you keep each rule on a single
    # line, and change only the value of the NAME= key.
    
    # PCI device 0x8086:0x100f (e1000)
    SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:0c:29:9c:8c:31", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

ここまでできたらovs-vsctlコマンドを使ってopenvswitchの状況を確認しましょう．

    $ sudo ovs-vsctl show
    c21d9943-5f76-4fcf-b42c-2aa22f5d590c
        Bridge "ovsbr0"
            Port "eth0"
                Interface "eth0"
            Port "ovsbr0"
                Interface "ovsbr0"
                    type: internal
        ovs_version: "1.7.3"

Bridge "ovsbr0"配下にeth0インタフェースがあることが確認できます．
type interalのInterface "ovsbr0"というのが自動的に割り当てられた
CentOS用のインタフェースになります．PortとInterfaceって何が違うのか，
調べたのですが，よくわかりません．
